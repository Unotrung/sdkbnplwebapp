<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="voolo-css.css">
    <title>Document</title>
</head>

<body>
    <div class="main-page">
        <div id='test'></div>
    </div>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js' 
    integrity='sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==' 
    crossorigin='anonymous' 
    referrerpolicy='no-referrer'>
    </script>

    <script type='text/javascript' src="https://hv-camera-web-sg.s3-ap-southeast-1.amazonaws.com/hyperverge-web-sdk@3.5.1/src/sdk.min.js">
    </script>

    <script type='text/javascript' >
        let selfieImage = '';
        let frontNidImage = '';
        let backNidImage = '';

        // currentShot use for check back or front image, not selfie
        let currentShot = '';
        let selfieImageCompleted = '';
        let frontNidImageCompleted = '';
        let backNidImageCompleted = '';

        let image = '';
        let base64 = '';

        async function fetchToken() {
            try {
                const url = 'https://apibnpl.voolo.vn/v1/bnpl/fec/getHVToken';
                const data = await fetch(url);
                const json = await data.json();
                const { token } = json;
                const jwttoken = token.split(' ')[1];
                return jwttoken;
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
            }
        };

        async function getHV() {
            try {
                await fetchToken()
                    .then((res) => {
                        HyperSnapSDK.init(res, HyperSnapParams.Region.AsiaPacific);
                        HyperSnapSDK.startUserSession();
                    })
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
        }
        };

        async function LaunchFaceCaptureScreen() {
            try {
                console.log('Launch Face Capture Screen');
                var hvFaceConfig = new HVFaceConfig();
                hvFaceConfig.setShouldShowInstructionPage(true);
                callback = (HVError, HVResponse) => {
                    if (HVError) {
                        var errorCode = HVError.getErrorCode();
                        console.log('error code Face Capture Screen: ', errorCode);
                        var errorMessage = HVError.getErrorMessage();
                        console.log('error message Face Capture Screen: ', errorMessage);
                    }
                    if (HVResponse) {
                        var apiResults = HVResponse.getApiResult();
                        console.log('Api Results Face Capture Screen: ', apiResults);
                        var apiHeaders = HVResponse.getApiHeaders();
                        console.log('Api Headers Face Capture Screen: ', apiHeaders);
                        var imageBase64 = HVResponse.getImageBase64();
                        console.log('Image Base64 Face Capture Screen: ', imageBase64);
                        var attemptsCount = HVResponse.getAttemptsCount();
                        console.log('Attempt Count Face Capture Screen: ', attemptsCount);
                        if(imageBase64 !== '' && imageBase64 !== null){
                            localStorage.setItem('selfie-image', imageBase64);
                            alert('Lưu ảnh Selfie thành công !');
                        }
                    }
                };
               HVFaceModule.start(hvFaceConfig, callback);
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
        }
        };

        async function LaunchDocumentCaptureScreen(side) {
            try {
                console.log('Launch Document Capture Screen');
                var hvDocConfig = new HVDocConfig();
                if(side === 'FRONT'){
                    hvDocConfig.setOCRDetails("https://vnm-docs.hyperverge.co/v2/nationalID", hvDocConfig.DocumentSide.FRONT, {}, {});
                }
                else if(side === 'BACK'){
                    hvDocConfig.setOCRDetails("https://vnm-docs.hyperverge.co/v2/nationalID", hvDocConfig.DocumentSide.BACK, {}, {});
                }
                callback = (HVError, HVResponse) => {
                    if (HVError) {
                        var errorCode = HVError.getErrorCode();
                        console.log('error code Document Capture Screen: ', errorCode);
                        var errorMessage = HVError.getErrorMessage();
                        console.log('error message Document Capture Screen: ', errorCode);
                    }
                    if (HVResponse) {
                        var apiResults = HVResponse.getApiResult();
                        console.log('Api Results Document Capture Screen: ', apiResults);
                        var apiHeaders = HVResponse.getApiHeaders();
                        console.log('Api Headers Document Capture Screen: ', apiHeaders);
                        var imageBase64 = HVResponse.getImageBase64();
                        // console.log('Image Base64 Document Capture Screen: ', imageBase64);
                        var attemptsCount = HVResponse.getAttemptsCount();
                        console.log('Attempt Count Document Capture Screen: ', attemptsCount);
                        base64 = imageBase64;
                        if(imageBase64 !== '' && imageBase64 !== null){
                            if(side === 'FRONT'){
                                localStorage.setItem('front-image', imageBase64);
                                postNationalID(imageBase64);
                                alert('Lưu mặt trước CMND thành công !');
                            }
                            else if(side === 'BACK'){
                                localStorage.setItem('back-image', imageBase64);
                                alert('Lưu mặt sau CMND thành công !');
                            }
                        }
                    }
                };
                HVDocsModule.start(hvDocConfig, callback);
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
            }
        }

        function deleteImage(side){
            try{
                if(side === 'SELFIE'){
                    localStorage.removeItem('selfie-image');
                    alert('Xóa ảnh selfie thành công !');
                }
                else if(side === 'FRONT'){
                    localStorage.removeItem('front-image');
                    alert('Xóa mặt trước selfie thành công !');
                }
                else{
                    localStorage.removeItem('back-image');
                    alert('Xóa mặt sau selfie thành công !');
                }
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
            }
        }

        function runFaceCaptureScreen() {
            try {
                 getHV()
                .then(() =>  LaunchFaceCaptureScreen());
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
            }
        }

        function runDocumentCaptureScreen() {
            try {
                 getHV()
                .then(() => LaunchDocumentCaptureScreen('FRONT'))
            }
            catch (error) {
                return {
                    errorCode: error.status || 500,
                    errorMessage: error.message
                }
            }
        }

        function acceptImage(side, image, data){
            if(side === 'SELFIE'){
                selfieImage = image;
                selfieImageCompleted = true;
                return;
            }
            currentShot = side;
            if(side === 'FRONT'){
                frontNidImage = image;
                frontNidImageCompleted = true;
            }
            if(side === 'BACK'){
                backNidImage = image;
                backNidImageCompleted = true;
            }
        }



        function postNationalID(ImageURL) {
            var form = document.getElementById("myAwesomeForm");
            $("#hinh").attr('src',ImageURL);
            // Split the base64 string in data and contentType
            var block = ImageURL.split(";");
            // Get the content type of the image
            var contentType = block[0].split(":")[1];// In this case "image/gif"
            // get the real base64 content of the file
            var realData = block[1].split(",")[1];// In this case "R0lGODlhPQBEAPeoAJosM...."

            // Convert it to a blob to upload
            var blob = b64toBlob(realData, contentType);

            // Create a FormData and append the file with "image" as parameter name
            var formDataToUpload = new FormData(form);
            formDataToUpload.append("image", blob);
            console.log("formDataToUpload : ",formDataToUpload);
            
            getToken();
            var settings = {
            "url": "https://vnm-docs.hyperverge.co/v2/nationalID",
            "method": "POST",
            "timeout": 0,
            "headers": {
                "appId": "abe84d",
                "appKey": "7d2c0d7e1690c216458c",
                "transactionId": "6bdec326-5eff-4492-b045-160816e61cea"
            },
            "async":false,
            "processData": false,
            "mimeType": "multipart/form-data",
            "contentType": false,
            "data": formDataToUpload
            };

            $.ajax(settings).done(function (response) {
                console.log(response);
            });

        }

        function getToken(){
            var settings = {
                "url": "https://auth.hyperverge.co/login",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/json"
                },
                "data": JSON.stringify({
                    "appId": "abe84d",
                    "appKey": "7d2c0d7e1690c216458c",
                    "expiry": 300
                }),
            };

            $.ajax(settings).done(function (response) {
                console.log(response);
            });
        }

        function convertBase64ToBlob(dataURI){
            let byteString;
            if (dataURI.split(',')[0].indexOf('base64') >= 0)
                byteString = atob(dataURI.split(',')[1]);
            else
                byteString = unescape(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ia = new Uint8Array(byteString.length);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ia], {type: mimeString});
        }

        function b64toBlob(b64Data, contentType, sliceSize) {
            contentType = contentType || '';
            sliceSize = sliceSize || 512;

            var byteCharacters = atob(b64Data);
            var byteArrays = [];

            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                var slice = byteCharacters.slice(offset, offset + sliceSize);

                var byteNumbers = new Array(slice.length);
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }

                var byteArray = new Uint8Array(byteNumbers);

                byteArrays.push(byteArray);
            }

            var blob = new Blob(byteArrays, {type: contentType});
            return blob;
        }
        // runFaceCaptureScreen();
        
        // getToken();
        // runDocumentCaptureScreen();
        // deleteImage('SELFIE');

        // console.log('Font Nid Image: ', localStorage.getItem('front-image'));
        // console.log(postNationalID(localStorage.getItem('front-image')));
    </script>

    <script type='module'>
        import { showProgressbar, updateProgressbar, showCircularProgressbar, updateCircularProgressbar, showAllTenor, showAllProvider,showUICheck,configUi } from './frontend.js';
        
        showUICheck("#test",'phone');
        configUi({
            logo:true
        });
        // showProgressbar('#test');
        // updateProgressbar();

        // showCircularProgressbar('#test');
        // updateCircularProgressbar();

        // showAllTenor('#test');
        // showAllProvider('#test');
    </script>

</body>
</html>